<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2º Torneio EDHBECK - C150 Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-color: #38bdf8; /* Electric Blue */
            --background-dark: #111827; /* Tailwind gray-900 */
            --card-bg: rgba(31, 41, 55, 0.5);
            --border-color: rgba(55, 65, 81, 0.6);
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-dark);
            background-image: radial-gradient(var(--text-secondary) 0.5px, transparent 0.5px), radial-gradient(var(--text-secondary) 0.5px, var(--background-dark) 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            color: var(--text-primary);
        }
        .glass-card {
            background: var(--card-bg);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .mesa-card {
             background-color: rgba(55, 65, 81, 0.4);
        }
        .player-winner {
            color: #facc15; /* yellow-400 */
            font-weight: 700;
        }
        .player-winner::before {
            content: '⭐ ';
        }
        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            transition: all 0.2s ease-in-out;
        }
        .icon-btn:hover {
            transform: scale(1.15);
            filter: brightness(1.2);
        }
        .timer-finished {
            color: #ef4444; /* red-500 */
        }
        .scoreboard-entry {
            transition: all 0.3s ease;
        }
        .scoreboard-entry-1st {
            background: linear-gradient(135deg, rgba(250, 204, 21, 0.2), rgba(250, 204, 21, 0.05));
            border-left: 4px solid #facc15; /* yellow-400 */
        }
        .scoreboard-entry-2nd {
            background: linear-gradient(135deg, rgba(209, 213, 219, 0.2), rgba(209, 213, 219, 0.05));
            border-left: 4px solid #d1d5db; /* gray-300 */
        }
        .scoreboard-entry-3rd {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.2), rgba(205, 127, 50, 0.05));
            border-left: 4px solid #CD7F32; /* Bronze */
        }
        .accent-text {
            color: var(--accent-color);
        }
        .accent-bg {
             background-color: var(--accent-color);
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="container mx-auto max-w-7xl">

        <header class="text-center mb-12">
            <h1 class="text-4xl sm:text-5xl font-bold accent-text mb-2">
                2º torneio EDHBECK - C150 Edition
            </h1>
            <p class="text-lg" style="color: var(--text-secondary);">Sistema de Gerenciamento de Torneio</p>
        </header>

        <!-- Player Setup -->
        <div id="setup-container">
            <section class="glass-card rounded-xl p-6 mb-12 max-w-3xl mx-auto">
                <h2 class="text-2xl font-bold mb-4 text-center accent-text">Inscrição de Jogadores</h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="text" id="player-name-input" placeholder="Nome do Jogador" class="w-full bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-[var(--accent-color)] focus:outline-none">
                    <button id="add-player-btn" class="accent-bg text-white font-bold py-2 px-6 rounded-lg hover:opacity-90 transition-opacity whitespace-nowrap">Adicionar Jogador</button>
                </div>
                <div id="player-list-setup" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    <!-- Lista de jogadores adicionados -->
                </div>
                <div class="text-center mt-6">
                    <button id="start-tournament-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors text-lg disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                        Iniciar Torneio (0/12)
                    </button>
                </div>
            </section>
        </div>

        <!-- Tournament View -->
        <div id="tournament-container" class="hidden">
            <section class="glass-card rounded-xl p-6 mb-12">
                <h2 class="text-2xl font-bold mb-4 text-center accent-text">Placar Geral</h2>
                <div id="scoreboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-lg">
                    <!-- Scores serão inseridos aqui pelo JS -->
                </div>
            </section>

            <main id="rounds-container" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Rodadas serão geradas e inseridas aqui -->
            </main>

            <div id="controls-container" class="text-center mt-8">
                <!-- Botões de controle das rodadas serão inseridos aqui -->
            </div>
        </div>

    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // State management
    let state = {
        players: {}, // { name: { score: 0 } }
        playerList: [
            'Caio', 'Duh', 'Vitor', 'Arlei', 'Miguel', 'Conde', 
            'Angela', 'Julius', 'João', 'Eduardo', 'Alvinho', 'Iuri'
        ],
        currentRound: 0,
        roundData: {}, // { 1: { mesa1: [], ... }, 2: ... }
        timers: {},
        matches: {},
    };

    const icons = {
        start: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M240,128a112,112,0,1,1-112-112A112,112,0,0,1,240,128Zm-152-80,96,80-96,80Z"></path></svg>`,
        pause: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm-8,160a8,8,0,0,1-16,0V72a8,8,0,0,1,16,0Zm48,0a8,8,0,0,1-16,0V72a8,8,0,0,1,16,0Z"></path></svg>`,
        add: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M228.44,108.69,147.31,27.56a12,12,0,0,0-17,0L49.44,108.41a12,12,0,0,0-3.37,9.31L42.63,208a12,12,0,0,0,12,12.63l90.34-3.44a12,12,0,0,0,9.31-3.37l80.87-80.88a12,12,0,0,0,0-17ZM136,51.88,204.12,120H136ZM120,204.12,51.88,136H120Zm101-101.06-20,20-68.12-68.12,20-20a4,4,0,0,1,5.66,0l42.43,42.42a4,4,0,0,1,0,5.66Z"></path></svg>`,
        remove: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm48-88H80a8,8,0,0,1,0-16h96a8,8,0,0,1,0,16Z"></path></svg>`
    };

    // DOM Elements
    const setupContainer = document.getElementById('setup-container');
    const tournamentContainer = document.getElementById('tournament-container');
    const playerNameInput = document.getElementById('player-name-input');
    const addPlayerBtn = document.getElementById('add-player-btn');
    const playerListSetup = document.getElementById('player-list-setup');
    const startTournamentBtn = document.getElementById('start-tournament-btn');
    const roundsContainer = document.getElementById('rounds-container');
    const scoreboard = document.getElementById('scoreboard');
    const controlsContainer = document.getElementById('controls-container');

    function saveState() {
        localStorage.setItem('torneioState', JSON.stringify(state));
    }

    function loadState() {
        const savedState = localStorage.getItem('torneioState');
        if (savedState) {
            const loaded = JSON.parse(savedState);
            // Don't overwrite player list if it's already pre-filled and we're starting fresh
            const playerListToKeep = state.playerList.length === 12 && loaded.playerList.length === 0 ? state.playerList : loaded.playerList;
            state = { ...state, ...loaded, playerList: playerListToKeep };
        
            if (state.currentRound > 0) {
                setupContainer.classList.add('hidden');
                tournamentContainer.classList.remove('hidden');
                
                // Re-render all completed rounds
                for (let i = 1; i <= state.currentRound; i++) {
                    renderRound(i, state.roundData[i]);
                }
                
                // Restore timer states
                Object.keys(state.timers).forEach(roundId => {
                     const timerData = state.timers[roundId];
                     const timerEl = document.querySelector(`.timer[data-round="${roundId}"]`);
                     if(timerEl) {
                        timerEl.textContent = formatTime(timerData.duration);
                        const button = document.querySelector(`.timer-control-btn[data-round="${roundId}"]`);
                        if(timerData.duration <=0) {
                             timerEl.classList.add('timer-finished');
                             button.innerHTML = 'Finalizado';
                             button.disabled = true;
                             button.classList.add('bg-red-600', 'cursor-not-allowed');
                        } else if(timerData.state === 'paused') {
                            button.innerHTML = icons.start; button.dataset.action = 'resume'; button.title = 'Retomar';
                            button.classList.remove('bg-yellow-500'); button.classList.add('bg-blue-500');
                        }
                     }
                });

                // Restore match scores and winners
                Object.keys(state.matches).forEach(rowId => {
                    const playerRow = document.getElementById(rowId);
                    if (playerRow) {
                        const matchData = state.matches[rowId];
                        const matchScoreSpan = playerRow.querySelector('.match-score');
                        const nameSpan = playerRow.querySelector('.player-name');
                        matchScoreSpan.dataset.matchScore = matchData.matchScore;
                        matchScoreSpan.textContent = `${matchData.matchScore} Pts`;
                        if (matchData.isWinner) nameSpan.classList.add('player-winner');
                    }
                });
                
                updateScoreboard();
                renderControlButtons();
            } else if (state.playerList.length > 0) {
                renderPlayerListSetup();
            }
        } else {
             renderPlayerListSetup();
        }
    }
    
    // --- Setup Logic ---
    function renderPlayerListSetup() {
        playerListSetup.innerHTML = state.playerList.map(name =>
            `<div class="bg-gray-800 p-2 rounded-md text-center">${name}</div>`
        ).join('');
        startTournamentBtn.textContent = `Iniciar Torneio (${state.playerList.length}/12)`;
        startTournamentBtn.disabled = state.playerList.length !== 12;
    }

    function handleAddPlayer() {
        const name = playerNameInput.value.trim();
        if (name && state.playerList.length < 12 && !state.playerList.includes(name)) {
            state.playerList.push(name);
            playerNameInput.value = '';
            renderPlayerListSetup();
            saveState();
        }
    }

    // --- Tournament Logic ---
    function handleStartTournament() {
        // Clear previous tournament data if any, except player list
        state.players = {};
        state.playerList.forEach(name => { state.players[name] = { score: 0 }; });
        state.currentRound = 1;
        state.roundData = {};
        state.timers = {};
        state.matches = {};

        // Generate Round 1
        const shuffledPlayers = [...state.playerList].sort(() => 0.5 - Math.random());
        state.roundData[1] = {
            mesa1: shuffledPlayers.slice(0, 4),
            mesa2: shuffledPlayers.slice(4, 8),
            mesa3: shuffledPlayers.slice(8, 12),
        };
        
        setupContainer.classList.add('hidden');
        tournamentContainer.classList.remove('hidden');
        
        roundsContainer.innerHTML = ''; // Clear previous rounds from UI
        renderRound(1, state.roundData[1]);
        updateScoreboard();
        renderControlButtons();
        saveState();
    }
    
    function handleGenerateNextRound() {
        const nextRound = state.currentRound + 1;
        let newRoundData = {};

        if (nextRound === 2 || nextRound === 3) {
            const prevRound = state.currentRound;
            const results = {};
            for (let i = 1; i <= 3; i++) {
                results[`mesa${i}`] = getTableResults(prevRound, i);
            }
            
            newRoundData.mesa1 = [results.mesa1[0], results.mesa2[0], results.mesa3[0], results.mesa3[3]];
            newRoundData.mesa2 = [results.mesa1[1], results.mesa2[1], results.mesa3[1], results.mesa2[3]];
            newRoundData.mesa3 = [results.mesa1[2], results.mesa2[2], results.mesa3[2], results.mesa1[3]];

        } else if (nextRound === 4) {
            const sortedPlayers = getOverallRanking();
            newRoundData.mesa1 = sortedPlayers.slice(0, 4);
            newRoundData.mesa2 = sortedPlayers.slice(4, 8);
            newRoundData.mesa3 = sortedPlayers.slice(8, 12);
        }

        state.currentRound = nextRound;
        state.roundData[nextRound] = newRoundData;
        renderRound(nextRound, newRoundData);
        renderControlButtons();
        saveState();
    }

    function getTableResults(round, table) {
        const roundCard = document.querySelector(`#round-${round}-card`);
        const tableCard = roundCard.querySelectorAll('.mesa-card')[table - 1];
        const playersInTable = Array.from(tableCard.querySelectorAll('.player-name')).map(span => {
            const name = span.dataset.player;
            const score = parseInt(span.closest('.flex').querySelector('.match-score').dataset.matchScore, 10);
            return { name, score };
        });
        
        playersInTable.sort((a, b) => b.score - a.score);
        
        for (let i = 0; i < playersInTable.length - 1; i++) {
            if (playersInTable[i].score === playersInTable[i+1].score && Math.random() > 0.5) {
                [playersInTable[i], playersInTable[i+1]] = [playersInTable[i+1], playersInTable[i]];
            }
        }
        
        return playersInTable.map(p => p.name);
    }
    
    function getOverallRanking() {
        const sorted = Object.entries(state.players).sort(([,a],[,b]) => b.score - a.score);
         for (let i = 0; i < sorted.length - 1; i++) {
            if (sorted[i][1].score === sorted[i+1][1].score && Math.random() > 0.5) {
                [sorted[i], sorted[i+1]] = [sorted[i+1], sorted[i]];
            }
        }
        return sorted.map(p => p[0]);
    }

    // --- Rendering Logic ---
    function renderControlButtons() {
        controlsContainer.innerHTML = '';
        if (state.currentRound > 0 && state.currentRound < 4) {
            const btn = document.createElement('button');
            btn.id = 'generate-next-round-btn';
            btn.className = 'accent-bg text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity text-lg';
            btn.textContent = `Finalizar Rodada ${state.currentRound} e Gerar Rodada ${state.currentRound + 1}`;
            btn.addEventListener('click', handleGenerateNextRound);
            controlsContainer.appendChild(btn);
        }
    }
    
    function renderRound(roundNumber, tablesData) {
        const roundCard = document.createElement('div');
        roundCard.id = `round-${roundNumber}-card`;
        roundCard.className = `glass-card rounded-xl p-6 ${roundNumber === 4 ? 'md:col-span-2' : ''}`;
        
        let tablesHTML = '';
        Object.entries(tablesData).forEach(([mesaKey, players]) => {
            const mesaNumber = mesaKey.replace('mesa', '');
            const playersHTML = players.map(name => `<li>${name}</li>`).join('');
            tablesHTML += `
                <div class="mesa-card rounded-lg p-4">
                    <h3 class="font-semibold text-xl accent-text mb-3">Mesa ${mesaNumber}</h3>
                    <ul class="space-y-3 player-list">${playersHTML}</ul>
                </div>
            `;
        });
        
        roundCard.innerHTML = `
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 border-b-2 pb-3 gap-4" style="border-color: var(--border-color);">
                <h2 class="text-3xl font-bold">Rodada ${roundNumber}${roundNumber === 4 ? ' - Final' : ''}</h2>
                <div class="flex items-center gap-4 bg-gray-900/50 rounded-full px-4 py-2">
                    <span class="timer text-2xl font-bold text-yellow-300" data-round="${roundNumber}">01:00:00</span>
                    <button class="timer-control-btn icon-btn bg-green-500 text-white" data-round="${roundNumber}" data-action="start" title="Iniciar"></button>
                </div>
            </div>
            <div class="space-y-4">${tablesHTML}</div>
        `;
        
        roundsContainer.appendChild(roundCard);
        initializeRoundUI(roundCard);
    }

    function initializeRoundUI(roundCard) {
        const roundId = roundCard.id.split('-')[1];
        
        roundCard.querySelectorAll('.player-list li').forEach((li, j) => {
            const playerName = li.textContent.trim();
            const mesaId = li.closest('.mesa-card').querySelector('h3').textContent.split(' ')[1];
            const rowId = `r${roundId}-m${mesaId}-p${j}`;
            li.innerHTML = `
                <div class="flex items-center justify-between w-full" id="${rowId}">
                    <span class="player-name text-lg" data-player="${playerName}">${playerName}</span>
                    <div class="flex items-center gap-2">
                        <span class="match-score font-bold text-gray-400 w-16 text-right pr-2" data-match-score="0">0 Pts</span>
                        <button class="icon-btn bg-yellow-400 text-gray-900 text-xl" title="Vitória (+2 Pts)" data-action="win">⭐</button>
                        <button class="icon-btn accent-bg text-white" title="Abate (+1 Pt)" data-action="add">${icons.add}</button>
                        <button class="icon-btn bg-red-500 text-white" title="Remover (-1 Pt)" data-action="remove">${icons.remove}</button>
                    </div>
                </div>`;
        });
        
        const timerBtn = roundCard.querySelector('.timer-control-btn');
        timerBtn.innerHTML = icons.start;
        if (!state.timers[roundId]) {
            state.timers[roundId] = { intervalId: null, duration: 3600, state: 'initial' };
        }
    }
    
    function updateScoreboard() {
        scoreboard.innerHTML = '';
        const sortedPlayers = Object.entries(state.players).sort(([, a], [, b]) => b.score - a.score);
        sortedPlayers.forEach(([name, data], index) => {
            const playerScoreDiv = document.createElement('div');
            let rankClass = '';
            if (index === 0 && data.score > 0) rankClass = 'scoreboard-entry-1st';
            else if (index === 1 && data.score > 0) rankClass = 'scoreboard-entry-2nd';
            else if (index === 2 && data.score > 0) rankClass = 'scoreboard-entry-3rd';
            
            playerScoreDiv.className = `scoreboard-entry ${rankClass} p-3 rounded-lg flex justify-between items-center`;
            playerScoreDiv.innerHTML = `<span class="font-semibold text-lg"><span class="inline-block w-6 text-gray-400">${index + 1}.</span>${name}</span><span class="font-bold accent-text text-xl">${data.score} Pts</span>`;
            scoreboard.appendChild(playerScoreDiv);
        });
    }

    function formatTime(seconds) {
        if(seconds < 0) seconds = 0;
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    // --- Event Listeners ---
    addPlayerBtn.addEventListener('click', handleAddPlayer);
    playerNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleAddPlayer();
    });
    startTournamentBtn.addEventListener('click', handleStartTournament);

    tournamentContainer.addEventListener('click', (event) => {
        const button = event.target.closest('button');
        if (!button) return;

        // Timer controls
        if (button.classList.contains('timer-control-btn')) {
            const roundId = button.dataset.round;
            const action = button.dataset.action;
            const timerData = state.timers[roundId];
            const timerEl = document.querySelector(`.timer[data-round="${roundId}"]`);

            if (action === 'start' || action === 'resume') {
                button.innerHTML = icons.pause; button.dataset.action = 'pause'; button.title = 'Pausar';
                button.classList.remove('bg-green-500','bg-blue-500'); button.classList.add('bg-yellow-500');
                timerData.state = 'running';
                timerData.intervalId = setInterval(() => {
                    timerData.duration--;
                    timerEl.textContent = formatTime(timerData.duration);
                    if (timerData.duration <= 0) {
                        clearInterval(timerData.intervalId);
                        timerEl.classList.add('timer-finished'); button.innerHTML = 'Finalizado'; button.disabled = true;
                        button.classList.remove('bg-yellow-500'); button.classList.add('bg-red-600', 'cursor-not-allowed');
                        timerData.state = 'finished';
                    }
                    saveState();
                }, 1000);
            } else if (action === 'pause') {
                clearInterval(timerData.intervalId);
                timerData.intervalId = null;
                button.innerHTML = icons.start; button.dataset.action = 'resume'; button.title = 'Retomar';
                button.classList.remove('bg-yellow-500'); button.classList.add('bg-blue-500');
                timerData.state = 'paused';
            }
            saveState();
            return;
        }

        // Score controls
        const playerRow = button.closest('.flex.items-center.justify-between');
        if (!playerRow) return;
        
        const playerName = playerRow.querySelector('.player-name').dataset.player;
        const action = button.dataset.action;
        const matchScoreSpan = playerRow.querySelector('.match-score');
        let currentMatchScore = parseInt(matchScoreSpan.dataset.matchScore, 10);
        let totalScoreChange = 0;

        if (action === 'win') {
            const nameSpan = playerRow.querySelector('.player-name');
            const isWinner = nameSpan.classList.contains('player-winner');
            const mesa = button.closest('.player-list');

            mesa.querySelectorAll('.player-name.player-winner').forEach(winnerSpan => {
                if (winnerSpan !== nameSpan) {
                    const otherRow = winnerSpan.closest('.flex');
                    const otherMatchScoreSpan = otherRow.querySelector('.match-score');
                    otherMatchScoreSpan.dataset.matchScore = Math.max(0, parseInt(otherMatchScoreSpan.dataset.matchScore, 10) - 2);
                    otherMatchScoreSpan.textContent = `${otherMatchScoreSpan.dataset.matchScore} Pts`;
                    state.players[winnerSpan.dataset.player].score = Math.max(0, state.players[winnerSpan.dataset.player].score - 2);
                    winnerSpan.classList.remove('player-winner');
                }
            });

            if (isWinner) {
                totalScoreChange = -2;
                currentMatchScore -= 2;
                nameSpan.classList.remove('player-winner');
            } else {
                totalScoreChange = 2;
                currentMatchScore += 2;
                nameSpan.classList.add('player-winner');
            }
        } else if (action === 'add') {
            totalScoreChange = 1;
            currentMatchScore += 1;
        } else if (action === 'remove' && state.players[playerName].score > 0 && currentMatchScore > 0) {
            totalScoreChange = -1;
            currentMatchScore -= 1;
        }

        matchScoreSpan.dataset.matchScore = currentMatchScore;
        matchScoreSpan.textContent = `${currentMatchScore} Pts`;
        state.players[playerName].score += totalScoreChange;
        if (state.players[playerName].score < 0) state.players[playerName].score = 0;
        
        state.matches[playerRow.id] = {
            matchScore: currentMatchScore,
            isWinner: playerRow.querySelector('.player-name').classList.contains('player-winner')
        };

        updateScoreboard();
        saveState();
    });

    // Initial load
    loadState();
});
</script>

</body>
</html>

